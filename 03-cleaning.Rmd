# Data transformation

The raw dataset contains 195 variables with 8378 rows. Only a subset of 195 variables are included in our analysis (more detail for this step in data transformation section). 


Below is a script file that we use to clean the dataset.

```{r, eval = FALSE}

speed_dating <- raw_dat %>% 
  select(iid,wave,gender,age,race,from,field,field_cd,undergra,mn_sat,tuition,income,
         imprace,expnum,
         sports:yoga,
         attr1_1:shar1_1,                                             # exp weight to others-1
         attr1_s:shar1_s,                                             # exp weight to others-2
         attr3_1:amb3_1,                                              # self-evaluate-1 (self)-1
         attr3_s:amb3_s,                                              # self-evaluate-1 (self)-2
         attr5_1:amb5_1,                                              # self-evaluate-2 (others)-1
         wave,pid,met_o,match,dec_o,int_corr,samerace,age_o,race_o,
         pf_o_att:pf_o_sha,                                           # score to others
         attr_o:shar_o,like_o,prob_o,                                 # score received
         attr1_2:shar1_2,                                             # exp weight to others-3
         attr3_2:amb3_2,                                              # self-evaluate-1 (self)-3
         attr5_2:amb5_2,                                              # self-evaluate-2 (others)-2
         you_call,them_cal,
         attr1_3:shar1_3,                                             # exp weight to others-4
         attr3_3:amb3_3,                                              # self-evaluate-1 (self)-4
         attr5_3:amb5_3,                                              # self-evaluate-2 (others)-3
         attr:shar,like,prob
         ) 

# add indicator columns

# get feature values of the partner
for (i in 1:nrow(speed_dating)) {
  # for each row, get partner's id
  pid = speed_dating[i, 'pid']
  # add temporary columns that holds partner's location, field, sports, reading, movies
  speed_dating[i, 'plocation'] = speed_dating[which(speed_dating$iid == pid)[1], 'from']
  speed_dating[i, 'pfield'] = speed_dating[which(speed_dating$iid == pid)[1], 'field']
}

# append indicator columns for location, field, and income
speed_dating['samelocation'] <- if_else(speed_dating$from == speed_dating$plocation, 'Yes', 'No')
speed_dating['samefield'] <- if_else(speed_dating$field == speed_dating$pfield, 'Yes', 'No')

# get the feature values of all the hobbies of the partner
f <- function(x){
  tmp <- data.frame("holder" = 1:dim(speed_dating)[1])
  result <- data.frame("holder" = 1:dim(speed_dating)[1])
  for (i in 1:nrow(speed_dating)){
    pid = speed_dating[i, 'pid']
    tmp[i,1] <- speed_dating[which(speed_dating$iid == pid)[1], x]
  }
  for (i in 1:nrow(speed_dating)) {
    result[i,1] <- if_else((tmp[i,1] >=7 & speed_dating[i,x]>=7), 'Yes', 'No')
  }
  return(result)
}
# append the newly added columns to the original data frame
names = colnames(speed_dating %>% select(sports:yoga))
common_features <- as.data.frame(do.call(cbind,lapply(names, f)))
colnames(common_features)<- paste0('same',colnames(speed_dating %>% select(sports:yoga)))
speed_dating <- cbind(speed_dating, common_features)
speed_dating <- speed_dating[, !duplicated(colnames(speed_dating))]

# drop unecessary columns and missing data
drops = c('plocation', 'pfield')
keeps = append(colnames(speed_dating %>% select(sports:yoga)), c('samelocation', 'samefield'))
speed_dating <- speed_dating[complete.cases(speed_dating[,keeps]), ]
```