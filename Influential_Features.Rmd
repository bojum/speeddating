
## Question: Will backrgound and common interests influence the match? Which feature is the most influential?



To answer this question, we have to look at background and common interests seperately. Background includes three features: `race`, `from`, and `field`. We can do so by comparing the chance of matching by conditioning on whether they are from the same `race`, same `from` (location), and same `field`. 

Data Cleaning:

we would like to append 6 indicator columns that indicates whether this person and his/her partner share that feature in common (actually 5 because samerace is available in the original data). 

```{r}
library(ggplot2)
library(tidyverse)
library(vcd)
library(jsonlite)
load('data/speed_dating.RData')
# get feature values of the partner
for (i in 1:nrow(speed_dating)) {
  # for each row, get partner's id
  pid = speed_dating[i, 'pid']
  # add temporary columns that holds partner's location, field, sports, reading, movies
  speed_dating[i, 'plocation'] = speed_dating[which(speed_dating$iid == pid)[1], 'from']
  speed_dating[i, 'pfield'] = speed_dating[which(speed_dating$iid == pid)[1], 'field']
}

# append indicator columns for location, field, and income
speed_dating['samelocation'] <- if_else(speed_dating$from == speed_dating$plocation, 'Yes', 'No')
speed_dating['samefield'] <- if_else(speed_dating$field == speed_dating$pfield, 'Yes', 'No')

# get the feature values of all the hobbies of the partner
f <- function(x){
  tmp <- data.frame("holder" = 1:dim(speed_dating)[1])
  result <- data.frame("holder" = 1:dim(speed_dating)[1])
  for (i in 1:nrow(speed_dating)){
    pid = speed_dating[i, 'pid']
    tmp[i,1] <- speed_dating[which(speed_dating$iid == pid)[1], x]
  }
  for (i in 1:nrow(speed_dating)) {
    result[i,1] <- if_else((tmp[i,1] >=7 & speed_dating[i,x]>=7), 'Yes', 'No')
  }
  return(result)
}
names = colnames(speed_dating %>% select(sports:yoga))
common_features <- as.data.frame(do.call(cbind,lapply(names, f)))
colnames(common_features)<- paste0('same',colnames(speed_dating %>% select(sports:yoga)))
speed_dating <- cbind(speed_dating, common_features)
speed_dating <- speed_dating[, !duplicated(colnames(speed_dating))]

# drop unecessary columns and missing data
drops = c('plocation', 'pfield')
keeps = append(colnames(speed_dating %>% select(sports:yoga)), c('samelocation', 'samefield'))
speed_dating_q1 <- speed_dating[complete.cases(speed_dating[,keeps]), ]
speed_dating <- speed_dating_q1
## end here
```

```{r}
save(speed_dating_q1, file = "data/speed_dating_q1.Rdata")
```

```{r}
# for mosaic plot 

# create a clean dataframe for each common feature
sameracedata = speed_dating %>% group_by(samerace, match) %>% summarise(Freq = n()) %>% ungroup() %>% mutate(samerace = if_else(samerace == 1, "Yes", "No")) %>% mutate(match = if_else(match == 1, "Yes", "No"))
samelocationdata = speed_dating %>% group_by(samelocation, match) %>% summarize(Freq = n()) %>% ungroup() %>% mutate(match = if_else(match == 1, "Yes", "No"))
samefielddata = speed_dating %>% group_by(samefield, match) %>% summarize(Freq = n()) %>% ungroup() %>% mutate(match = if_else(match == 1, "Yes", "No"))
samesportsdata = speed_dating %>% group_by(samesports, match) %>% summarize(Freq = n()) %>% ungroup() %>% mutate(match = if_else(match == 1, "Yes", "No"))
samereadingdata = speed_dating %>% group_by(samereading, match) %>% summarize(Freq = n()) %>% ungroup() %>% mutate(match = if_else(match == 1, "Yes", "No"))
samemoviesdata = speed_dating %>% group_by(samemovies, match) %>% summarize(Freq = n()) %>% ungroup() %>% mutate(match = if_else(match == 1, "Yes", "No"))
cat(
  paste(
  '<script>
    var sameracedata = ',toJSON(sameracedata),';
    var samelocationdata = ',toJSON(samelocationdata),';
    var samefielddata = ',toJSON(samefielddata),';
    var samesportsdata = ',toJSON(samesportsdata),';
    var samereadingdata = ',toJSON(samereadingdata),';
    var samemoviesdata = ',toJSON(samemoviesdata),';
  </script>'
  , sep="")
)
```

<script src="https://d3js.org/d3.v5.min.js"></script>
<svg width="910" height="550">		</svg>
<script>
  //initialize the svg
  var w = 910;
  var h = 550;
  var margin = {top: 25, right: 25, bottom: 25, left: 25};
  var innerWidth = w - margin.left - margin.right;
  var innerHeight = h - margin.top - margin.bottom;
  var dur = 500;
  
  var svg = d3.select("svg");
  svg.append("rect").attr("x", 0).attr("y", 0).attr("width", w).attr("height", h).attr("fill", "aliceblue");
  
  //initialize dataset
  var fill = "lightblue";
  var stroke = "#D0D3D4";
  var textfill = "#797D7F";
  
  var dataset = [{key: "race", value: sameracedata, f:"#2471A3", s:"#4B4C4D", tf: "#4B4C4D", axis: "Same Race", selected: "True", fw: "bold"}
                ,{key: "location", value: samelocationdata, f:fill, s:stroke, tf: textfill, axis: "from Same Location", selected: "False", fw: "normal"}
                ,{key: "field", value: samefielddata, f:fill, s:stroke, tf: textfill, axis: "Work in Same Field", selected: "False", fw: "normal"}
                ,{key: "sports", value: samesportsdata, f:fill, s:stroke, tf: textfill, axis: "Both love Sports", selected: "False", fw: "normal"}
                ,{key: "reading", value: samereadingdata, f:fill, s:stroke, tf: textfill, axis: "Both love Reading", selected: "False", fw: "normal"}
                ,{key: "movie", value: samemoviesdata, f:fill, s:stroke, tf: textfill, axis: "Both love Movies", selected: "False", fw: "normal"}];
  
  // use race feature as the initial plot
  var data = sameracedata;

  //manually transform to a mosaic plot
  function format(data){
    var offset = 50;
    var plotwidth = 400;
    var plotheight = 400;
    var bar2_x = (data[0].Freq+data[1].Freq)/d3.sum(data.map(d => d.Freq))*(plotwidth-5);
    var bar1_y = data[0].Freq/(data[0].Freq+data[1].Freq)*plotheight;
    var bar2_y = data[2].Freq/(data[2].Freq+data[3].Freq)*plotheight;
    return [{x: 2.5* offset, y: 1.5 * offset, w: bar2_x, h:bar1_y, f: "#D0D3D4", lx: bar2_x, t: "No", tx: 2.5 * offset+(bar2_x+5)/2, ty: 1.5 * offset -15},
            {x: 2.5* offset, y:bar1_y+1.5 * offset, w: bar2_x, h:plotheight-bar1_y, f: "#7B7D7D", t: "No", tx: 2.5 * offset-30, ty: bar1_y/2+1.5*offset},
            {x:bar2_x+5+2.5* offset, y:1.5 * offset, w: plotwidth-5-bar2_x, h: bar2_y, f: "#D0D3D4", t: "Yes", tx: 2.5 * offset+(bar2_x+5)+(plotwidth-(bar2_x+5))/2, ty: 1.5 * offset - 15},
            {x:bar2_x+5+2.5* offset, y: bar2_y+1.5 * offset, w:plotwidth-5-bar2_x, h: plotheight - bar2_y, f:"#7B7D7D", t: "Yes", tx:  2.5 * offset-30, ty: (plotheight - bar1_y)/2+bar1_y+1.5 * offset}];
  }
  
  //append the plot to a new group g
  var bars = svg.append("g")
                .attr("id", "plot")
                .attr("transform", `translate (${margin.left}, ${margin.top})`)
              .selectAll("rect")
                .data(format(data));
  
  // plot the initial plot
  bars.enter().append("rect")
      .attr("class", "bar")
      .attr("x", d => d.x)
      .attr("y", d => d.y)  
      .attr("width", d => d.w)
      .attr("height", d => d.h)
      .attr("fill",d => d.f)
      .attr("stroke", "#7B7D7D")
      .attr("stroke-width", "1");
      
  //add labels for axis
  svg.append("text")
      .attr("x", "50")
      .attr("y", "300")
      .attr("font-size","20")
      .attr("text-anchor","middle")
      .attr("font-family","helvetica")
      .attr("fill", "#313132")
      .attr("font-weight","bold")
      .text("Match");
                      
  var xlabel = svg.append("g")
                  .attr("id", "axis")
                  .attr("transform",`translate (${margin.left}, ${margin.top})`)
                .selectAll("text")
                  .data([dataset[0]], d=>d.key).enter()
                  .append("text")
                  .attr("x", "330")
                  .attr("y", "20")
                  .attr("font-size","20")
                  .attr("text-anchor","middle")
                  .attr("font-family","helvetica")
                  .attr("fill", "#313132")
                  .attr("font-weight","bold")
                  .text(d =>d.axis);        
  
  
  // add radio buttons
  var buttons1 = svg.append("g")
                    .attr("id", "buttons1")
                    .attr("class", "radio")
                    .attr("transform",  `translate (${margin.left}, ${margin.top})`)
                  .selectAll("circle")
                    .data(dataset, d=>d.key).enter().append("circle")
                    .attr("cx", "700")
                    .attr("cy", (d,i) => i*50+125)
                    .attr("r", "13")
                    .attr("fill", "aliceblue")
                    .attr("stroke", d=>d.s)
                    .attr("stroke-width", "3")
                    
  var buttons2 = svg.append("g")
                    .attr("id", "buttons2")
                    .attr("class", "radio")
                    .attr("transform",  `translate (${margin.left}, ${margin.top})`)
                  .selectAll("circle")
                    .data(dataset, d=>d.key).enter().append("circle")
                    .attr("cx", "700")
                    .attr("cy", (d,i) => i*50+125)
                    .attr("r", "6")
                    .attr("fill", d => d.f)
                    
  // add "Yes" and "No" text labels
  var labels = svg.select("g#plot").selectAll("text").data(format(data));
  
  labels.enter().append("text")
      .attr("id", "label")
      .attr("x", d=>d.tx)
      .attr("y", d=>d.ty)
      .attr("font-size","18")
      .attr("text-anchor","middle")
      .attr("font-family","helvetica")
      .attr("fill", "#313132")
      .text(d =>d.t); 
                
  //append text next to buttons
  var texts = svg.append("g")
                .attr("id", "texts")
                .attr("class", "radio")
                .attr("transform", `translate (${margin.left}, ${margin.top})`)
              .selectAll("text")
                .data(dataset, d=>d.key).enter().append("text")
                .attr("x", "730")
                .attr("y", (d, i) => i*50+130)
                .attr("fill", d=>d.tf)
                .attr("font-size","20")
                .attr("font-family", "helvetica")
                .attr("font-weight", d=>d.fw)
                .text(d=>d.key);
                    
  //switch event listeners if a button is clicked
  d3.selectAll("g.radio").selectAll("circle").on("click", function(){
    //update the chart
    update(format(d3.select(this).datum().value));
    //change the color of the radio buttons
    dataset.map(d => d.f = fill);
    dataset.map(d => d.s = stroke);
    dataset.map(d => d.tf = textfill);
    dataset.map(d => d.selected = "False");
    d3.select(this).datum().f = "#2471A3";
    d3.select(this).datum().s = "#4B4C4D";
    d3.select(this).datum().tf = "#4B4C4D";
    d3.select(this).datum().selected = "True";
    updatebutton(dataset);
    //change axis label
    xlabel.data([d3.select(this).datum()]).text(d=>d.axis);
  });
      
  // update method (using general update pattern)
  function update(data){
    var bars = svg.select("#plot").selectAll("rect").data(data);
    bars.transition().duration(dur)
        .ease(d3.easeLinear)
        .attr("x", d => d.x)
        .attr("y", d => d.y)  
        .attr("width", d => d.w)
        .attr("height", d => d.h);
    var labels = svg.selectAll("text#label").data(data);
    labels.transition().duration(dur)
        .ease(d3.easeLinear)
        .attr("x", d => d.tx)
        .attr("y", d => d.ty) 
  }
  
  // update method(for radio buttons)
  function updatebutton(dataset){
    buttons1.data(dataset).attr("stroke", d => d.s);
    buttons2.data(dataset).attr("fill", d=> d.f);
    texts.data(dataset).attr("fill", d=>d.tf).attr("font-weight", d=>d.fw);
  }
  
  d3.selectAll("g.radio").selectAll("circle").on("mouseover", handleMouseOver).on("mouseout", handleMouseOut);
  
  function handleMouseOver(){
    if(d3.select(this).datum().selected == "False"){
      d3.select(this).datum().f = "#4a9bd4";
      d3.select(this).datum().s = "#969696";
      d3.select(this).datum().tf = "#969696";
      d3.select(this).datum().fw = "bold";
      updatebutton(dataset);
    }
  }
  
  function handleMouseOut(){
    if(d3.select(this).datum().selected == "False"){
      d3.select(this).datum().f = fill;
      d3.select(this).datum().s = stroke;
      d3.select(this).datum().tf = textfill;
      d3.select(this).datum().fw = "normal";
      updatebutton(dataset);
    }
  }
</script>

We then look at all the available features that could be of common interest in the dataset, and see if any of those features heavily impacts the chances of getting matched.

```{r}
calc_diff <- function(x){
  tmp <- speed_dating %>% group_by_(x, 'match') %>% summarize(Freq = n()) %>% ungroup() %>% mutate(match = if_else(match == 1, "Yes", "No"))
  no_rate <- tmp[2,3]/(tmp[2,3]+tmp[1,3])
  yes_rate <- tmp[4,3]/(tmp[3,3]+tmp[4,3])
  return(yes_rate - no_rate)
}
cd_df <- do.call(rbind,lapply(paste0('same',colnames(speed_dating %>% select(sports:yoga))),calc_diff))*100
cd_df <- cbind(cd_df, names)

ggplot(cd_df,aes(x=Freq,y=fct_reorder(names,Freq)))+geom_point(color="blue")+ylab("")+xlab("Percent (%)")+ggtitle("Differences in Chance of Matching")
```

